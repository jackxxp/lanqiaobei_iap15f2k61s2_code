C51 COMPILER V9.60.7.0   MAIN                                                              02/02/2026 20:58:56 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Program Files (x86)\keil\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.H>
   2          #include "intrins.h"
   3          
   4          #define uchar unsigned char
   5          #define uint  unsigned int
   6          
   7          sbit TX = P1^0;
   8          sbit RX = P1^1;
   9          
  10          /* 数码管段码 */
  11          code uchar DuanMa[] =
  12          {
  13              0xc0,0xf9,0xa4,0xb0,0x99,
  14              0x92,0x82,0xf8,0x80,0x90,
  15              0xbf,0xff
  16          };
  17          
  18          uchar SMGa[8] = {11,11,11,11,11,11,11,11};
  19          uchar SMGi = 0;
  20          
  21          /* ================== 数码管控制 ================== */
  22          void control(char x, char y)
  23          {
  24   1          switch(x)
  25   1          {
  26   2              case 4: P2 = (P2 & 0x1f) | 0x80; break;
  27   2              case 5: P2 = (P2 & 0x1f) | 0xa0; break;
  28   2              case 6: P2 = (P2 & 0x1f) | 0xc0; break;
  29   2              case 7: P2 = (P2 & 0x1f) | 0xe0; break;
  30   2          }
  31   1          P0 = y;
  32   1          P2 &= 0x1f;
  33   1      }
  34          
  35          void aloneSMG(char pos, char value)
  36          {
  37   1          control(7, 0xff);
  38   1          control(6, 0x01 << pos);
  39   1          control(7, DuanMa[value]);
  40   1      }
  41          
  42          /* ================== 定时器0：1ms ================== */
  43          uchar Wave_Delay = 0;
  44          
  45          void T0_Init(void)
  46          {
  47   1          AUXR &= 0x7F;
  48   1          TMOD &= 0xF0;
  49   1          TMOD |= 0x01;
  50   1          TH0 = 0xFC;
  51   1          TL0 = 0x18;
  52   1          TF0 = 0;
  53   1          TR0 = 1;
  54   1          ET0 = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              02/02/2026 20:58:56 PAGE 2   

  55   1          EA  = 1;
  56   1      }
  57          
  58          void T0_ISR(void) interrupt 1
  59          {
  60   1          TH0 = 0xFC;
  61   1          TL0 = 0x18;
  62   1      
  63   1          aloneSMG(SMGi, SMGa[SMGi]);
  64   1          if(++SMGi == 8) SMGi = 0;
  65   1      
  66   1          if(++Wave_Delay >= 200)
  67   1              Wave_Delay = 0;
  68   1      }
  69          
  70          /* ================== 延时 ================== */
  71          void Delay12us(void)
  72          {
  73   1          uchar i = 33;
  74   1          while(--i);
  75   1      }
  76          
  77          /* ================== PCA 测距 ================== */
  78          uint Get_Distance(void)
  79          {
  80   1          uint time_us;
  81   1          uint timeout;
  82   1      
  83   1          CMOD = 0x00;
  84   1          CCON = 0x00;
  85   1          CH = 0;
  86   1          CL = 0;
  87   1      
  88   1          TX = 1;
  89   1          Delay12us();
  90   1          TX = 0;
  91   1      
  92   1          timeout = 30000;
  93   1          while(RX == 0)
  94   1              if(--timeout == 0) return 0;
  95   1      
  96   1          CH = 0;
  97   1          CL = 0;
  98   1          CR = 1;
  99   1      
 100   1          timeout = 30000;
 101   1          while(RX == 1)
 102   1              if(--timeout == 0)
 103   1              {
 104   2                  CR = 0;
 105   2                  return 0;
 106   2              }
 107   1      
 108   1          CR = 0;
 109   1      
 110   1          time_us = ((uint)CH << 8) | CL;
 111   1          return time_us / 58;
 112   1      }
 113          
 114          /* ================== 主函数 ================== */
 115          uint Distance = 0;
 116          
C51 COMPILER V9.60.7.0   MAIN                                                              02/02/2026 20:58:56 PAGE 3   

 117          void main(void)
 118          {
 119   1          uint New_Distance = 0;
 120   1      
 121   1          T0_Init();
 122   1      
 123   1          while(1)
 124   1          {
 125   2              if(Wave_Delay == 199)
 126   2              {
 127   3                  New_Distance = Get_Distance();
 128   3      
 129   3                  /* 无效值保护 */
 130   3                  if(New_Distance > 0)
 131   3                  {
 132   4                      /* 指数平滑滤波（核心） */
 133   4                      Distance = (Distance * 7 + New_Distance * 3) / 10;
 134   4                  }
 135   3              }
 136   2      
 137   2              SMGa[0] = 11;
 138   2              SMGa[1] = 11;
 139   2              SMGa[2] = 11;
 140   2              SMGa[3] = 11;
 141   2              SMGa[4] = 11;
 142   2              SMGa[5] = Distance / 100 % 10;
 143   2              SMGa[6] = Distance / 10  % 10;
 144   2              SMGa[7] = Distance % 10;
 145   2          }
 146   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    442    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
